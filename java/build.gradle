import com.github.jengelman.gradle.plugins.shadow.transformers.Log4j2PluginsCacheFileTransformer

//buildscript {
//    ext.kotlin_version = '1.3.70'
//    repositories {
//        mavenCentral()
//    }
//    dependencies {
//        classpath "org.jetbrains.kotlin.jvm:$kotlin_version"
//    }
//}

buildscript {
    ext.kotlin_version = '1.3.70'
}

plugins {
    id 'com.github.johnrengelman.shadow' version '5.2.0'
    id 'java'
    id 'org.jetbrains.kotlin.jvm' version "$kotlin_version"
}
apply plugin: 'base'
apply plugin: 'kotlin'



allprojects {
    group = 'com.github.Fernthedev'

    project.ext.protocol_ver = "1.5.3" // Build version
    project.ext.protocol_ver_min = "1.5.3" // Minimum build

    version = project.ext.protocol_ver

    repositories {
        jcenter()
        mavenLocal()
        mavenCentral()

        maven {
            url = 'https://jitpack.io'
        }

        maven {
            url = 'https://oss.sonatype.org/content/groups/public'
        }

        maven {
            url = 'https://repo.maven.apache.org/maven2'
        }
    }
}

configure(allprojects.findAll {it.name != "light-chat"}) {
    apply plugin: 'java'
    apply plugin: 'maven-publish'
    apply plugin: 'com.github.johnrengelman.shadow'

    ext.netty_ver = "4.1.43.Final"
    ext.jline_ver = "3.14.0"
    ext.log4j_ver = "2.13.1"

    repositories {
        jcenter()
        mavenLocal()
        mavenCentral()

        maven {
            url = 'https://jitpack.io'
        }

        maven {
            url = 'https://oss.sonatype.org/content/groups/public'
        }

        maven {
            url = 'https://repo.maven.apache.org/maven2'
        }
    }


    test {
        useJUnitPlatform()
    }

    dependencies {
        testImplementation 'org.junit.jupiter:junit-jupiter-api:5.6.0'
        testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.6.0'

        compile "io.netty:netty-all:$netty_ver"
        compile "io.netty:netty-transport-native-epoll:$netty_ver"
        compile "io.netty:netty-transport-native-kqueue:$netty_ver"
        compile 'com.lmax:disruptor:3.4.2'
        compile 'org.apache.commons:commons-lang3:3.8.1'
        compile 'com.github.Fernthedev:fern-configmanager:1.1.4'
        compile 'com.google.guava:guava:28.2-jre'
        compile 'com.googlecode.json-simple:json-simple:1.1.1'
        compile 'com.google.code.gson:gson:2.8.1'
        compile 'com.github.Fernthedev:FernUtils:1.2.0'
        compileOnly 'org.projectlombok:lombok:1.18.4'
        compile group: 'org.apache.maven', name: 'maven-artifact', version: '3.6.3'
        annotationProcessor 'org.projectlombok:lombok:1.18.4'
    }

    sourceCompatibility = '8'

    java {
        withSourcesJar()
        withJavadocJar()
    }

    processResources {
//        from 'resources'

        inputs.property "version", project.protocol_ver
        inputs.property "minVersion", project.protocol_ver_min

        from(sourceSets.main.resources.srcDirs) {
            include 'variables.json'


            expand 'version':project.protocol_ver, 'minVersion':project.protocol_ver_min
        }

    }

    publishing {
        publications {
            maven(MavenPublication) {
                from(components.java)

                groupId = "$rootProject.group.$rootProject.name"

                artifactId = "$project.name"

                println "Publishing $groupId:$artifactId:$version"

                java {
                    withSourcesJar()
                    withJavadocJar()
                }
            }
        }
    }


    jar.dependsOn(shadowJar)
    jar.classifier = 'old'
    shadowJar {
//        project.configurations.implementation.canBeResolved = true
//        configurations = [project.configurations.implementation]
        classifier = ''
        transform(Log4j2PluginsCacheFileTransformer)
//        transform(Log4j2PluginsCacheFileTransformer)
        minimize() {
            exclude (dependency('io.netty:netty-transport.*:.*') )
            exclude (dependency('log4j:log4j:.*') )
            exclude (dependency('org.apache.logging.log4j:.*:.*') )
            exclude (dependency('org.slf4j:slf4j-api:.*') )
            exclude (dependency('commons-logging:.*:.*') )
            exclude (dependency('com.pi4j:.*:.*') )
            exclude (dependency('org.fusesource.jansi:.*:.*') )
            exclude (dependency('org.jline:.*:.*') )
            exclude (dependency('net.minecrell:.*:.*') )
            exclude (dependency('com.lmax:disruptor:.*'))
            exclude ('.**/Log4j2Plugins.dat' )


        }
    }
}
repositories {
    mavenCentral()
}
dependencies {
    compile "org.jetbrains.kotlin:kotlin-stdlib-jdk8:$kotlin_version"
}
compileKotlin {
    kotlinOptions {
        jvmTarget = "1.8"
    }
}
compileTestKotlin {
    kotlinOptions {
        jvmTarget = "1.8"
    }
}
